

## Fix: Teacher Application RLS "New Row Violates Policy" Error

### Root Cause

The form uses `.insert(payload).select(...)` which in PostgREST requires the newly inserted row to pass **both** the INSERT and SELECT RLS policies. The INSERT policy allows everyone (`with_check: true`), but the SELECT policy restricts visibility to admin/registrar only. This causes the RLS violation for public applicants.

### Changes

**1. Update the insert call in `TeacherApplicationForm.tsx` (line 151)**

Remove the `.select()` chain from the insert, since public applicants don't need to read back the row. The reference number is generated by a trigger, but since we can't read it back without SELECT access, we'll handle it gracefully.

```typescript
// Before
const { data: insertedData, error } = await supabase
  .from('teacher_applications')
  .insert(payload)
  .select('id, reference_number, first_name, last_name, email')
  .maybeSingle();

// After
const { error } = await supabase
  .from('teacher_applications')
  .insert(payload);
```

Then update the success handling (lines 153-168) to remove references to `insertedData` and always show a generic confirmation, since the reference number will be delivered by the confirmation email.

**2. Add storage INSERT policy for authenticated users**

Run a migration to allow authenticated users to also upload to the `teacher-applications` storage bucket:

```sql
CREATE POLICY "Allow authenticated upload to teacher-applications"
ON storage.objects FOR INSERT TO authenticated
WITH CHECK (bucket_id = 'teacher-applications');
```

**3. Re-attach the reference number trigger (if missing)**

The trigger function `generate_teacher_application_ref` exists but no trigger is attached to the table. We need to create it:

```sql
CREATE TRIGGER set_teacher_application_ref
  BEFORE INSERT ON public.teacher_applications
  FOR EACH ROW
  WHEN (NEW.reference_number IS NULL)
  EXECUTE FUNCTION generate_teacher_application_ref();
```

### Summary of file changes

| File | Change |
|------|--------|
| `src/components/teacher-application/TeacherApplicationForm.tsx` | Remove `.select()` from insert call; simplify success handling |
| Database migration | Add storage policy for authenticated uploads; attach trigger |

